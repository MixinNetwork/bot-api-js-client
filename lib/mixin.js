!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("node-forge"),require("moment"),require("jsonwebtoken"),require("uuid"),require("int64-buffer")):"function"==typeof define&&define.amd?define(["node-forge","moment","jsonwebtoken","uuid","int64-buffer"],t):(e=e||self).Mixin=t(e.forge,e.moment,e.jwt,e.uuid,e.LittleEndian)}(this,function(w,m,l,c,b){"use strict";function d(e){return(d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return w=w&&Object.prototype.hasOwnProperty.call(w,"default")?w.default:w,m=m&&Object.prototype.hasOwnProperty.call(m,"default")?m.default:m,l=l&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l,b=b&&Object.prototype.hasOwnProperty.call(b,"default")?b.default:b,function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,i;return t=e,(n=[{key:"generateSessionKeypair",value:function(){var e=w.pki.rsa.generateKeyPair({bits:2048,e:65537}),t=w.asn1.toDer(w.pki.publicKeyToAsn1(e.publicKey)).getBytes();return{public:w.util.encode64(t,64),private:w.pki.privateKeyToPem(e.privateKey)}}},{key:"signAuthenticationToken",value:function(e,t,n,i,r,o,u){"object"===d(o)?o=JSON.stringify(o):"string"!=typeof o&&(o="");var a=m.utc().add(30,"minutes").unix(),s=w.md.sha256.create();s.update(w.util.encodeUtf8(i+r+o));var f={uid:e,sid:t,iat:m.utc().unix(),exp:a,jti:c.v4(),sig:s.digest().toHex(),scp:u};return l.sign(f,n,{algorithm:"RS512"})}},{key:"signEncryptedPin",value:function(e,t,n,i,r){var o;try{b&&(o=b.Int64BE),Uint64BE&&(o=Uint64BE)}catch(e){}var u=(i=w.pki.privateKeyFromPem(i)).decrypt(w.util.decode64(t),"RSA-OAEP",{md:w.md.sha256.create(),label:n}),a=new Uint8Array(new o(1e9*m.utc().unix()).buffer),a=w.util.createBuffer(a);r=r||a.getBytes();var s=new Uint8Array(new o(1e9*m.utc().unix()).buffer);s=(s=w.util.createBuffer(s)).getBytes();var f=w.util.createBuffer(e,"utf8"),l=w.util.createBuffer();l.putBytes(f),l.putBytes(s),l.putBytes(r);for(var c=16-f.length()%16,d=w.util.hexToBytes(c.toString(16));0<c;)c--,l.putBytes(d);var p=w.random.getBytesSync(16),y=w.cipher.createCipher("AES-CBC",u);return y.start({iv:p}),y.update(l),y.finish(),w.util.encode64(y.output.getBytes())}},{key:"hexToBytes",value:function(e){for(var t=[],n=0;n<e.length;n+=2)t.push(parseInt(e.substr(n,2),16));return t}},{key:"environment",value:function(){return this.getMixinContext().platform}},{key:"getMixinContext",value:function(){var e={};return window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.MixinContext?(e=JSON.parse(prompt("MixinContext.getContext()"))).platform=e.platform||"iOS":window.MixinContext&&"function"==typeof window.MixinContext.getContext&&((e=JSON.parse(window.MixinContext.getContext())).platform=e.platform||"Android"),e}},{key:"conversationId",value:function(){return this.getMixinContext().conversation_id}},{key:"reloadTheme",value:function(){switch(this.environment()){case"iOS":return void(window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.reloadTheme&&window.webkit.messageHandlers.reloadTheme.postMessage(""));case"Android":case"Desktop":return void(window.MixinContext&&"function"==typeof window.MixinContext.reloadTheme&&window.MixinContext.reloadTheme())}}}])&&r(t.prototype,n),i&&r(t,i),e}()});
