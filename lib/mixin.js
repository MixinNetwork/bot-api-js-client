!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("node-forge"),require("moment"),require("jsonwebtoken"),require("axios"),require("uuid"),require("int64-buffer")):"function"==typeof define&&define.amd?define(["node-forge","moment","jsonwebtoken","axios","uuid","int64-buffer"],t):(e=e||self).Mixin=t(e.forge,e.moment,e.jwt,e.axios,e.uuid,e.LittleEndian)}(this,function(v,x,l,s,c,b){"use strict";function p(e){return(p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return v=v&&Object.prototype.hasOwnProperty.call(v,"default")?v.default:v,x=x&&Object.prototype.hasOwnProperty.call(x,"default")?x.default:x,l=l&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l,s=s&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s,b=b&&Object.prototype.hasOwnProperty.call(b,"default")?b.default:b,function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,i;return t=e,(n=[{key:"generateSessionKeypair",value:function(){var e=v.pki.rsa.generateKeyPair({bits:2048,e:65537}),t=v.asn1.toDer(v.pki.publicKeyToAsn1(e.publicKey)).getBytes();return{public:v.util.encode64(t,64),private:v.pki.privateKeyToPem(e.privateKey)}}},{key:"signAuthenticationToken",value:function(e,t,n,i,r,o,a){"object"===p(o)?o=JSON.stringify(o):"string"!=typeof o&&(o="");var u=x.utc().add(30,"minutes").unix(),s=v.md.sha256.create();s.update(v.util.encodeUtf8(i+r+o));var f={uid:e,sid:t,iat:x.utc().unix(),exp:u,jti:c.v4(),sig:s.digest().toHex(),scp:a||"FULL"};return l.sign(f,n,{algorithm:"RS512"})}},{key:"encryptPin",value:function(e,t,n,i,r){var o;try{b&&(o=b.Int64LE),Uint64BE&&(o=Uint64LE)}catch(e){}var a=(i=v.pki.privateKeyFromPem(i)).decrypt(v.util.decode64(t),"RSA-OAEP",{md:v.md.sha256.create(),label:n}),u=new Uint8Array(new o(x.utc().unix()).buffer),u=v.util.createBuffer(u);r=(r=r||u).getBytes();var s=new Uint8Array(new o(x.utc().unix()).buffer);s=(s=v.util.createBuffer(s)).getBytes();var f=v.util.createBuffer(e,"utf8"),l=v.util.createBuffer();l.putBytes(f),l.putBytes(s),l.putBytes(r);for(var c=16-f.length()%16,p=v.util.hexToBytes(c.toString(16));0<c;)c--,l.putBytes(p);var d=v.random.getBytesSync(16),y=this.hexToBytes(v.util.binary.hex.encode(a)),w=v.cipher.createCipher("AES-CBC",y);w.start({iv:d}),w.update(l),w.finish(function(){return!0});var h=v.util.createBuffer();h.putBytes(d),h.putBytes(w.output.getBytes());var m=h.getBytes();return v.util.encode64(m)}},{key:"hexToBytes",value:function(e){for(var t=[],n=0;n<e.length;n+=2)t.push(parseInt(e.substr(n,2),16));return t}},{key:"request",value:function(e,t,n,i,r,o,a){var u=this.signAuthenticationToken(e,t,n,i,r,JSON.stringify(o));return s({method:i,url:"https://mixin-api.zeromesh.net"+r,data:o,headers:{"Content-Type":"application/json",Authorization:"Bearer "+u}}).then(function(e){if(!a)return e.data;a(e.data)})}},{key:"createUser",value:function(e,t,n,i,r){var o=this.generateSessionKeypair(),a=o.public,u=o.private;-1!==a.indexOf("-----")&&(function(e){throw new Error('"'+e+'" is read-only')}("publicKey"),a=a.split("-----")[2].replace(/\r?\n|\r/g,""));var s=u,f={session_secret:a,full_name:e};return this.request(t,n,i,"POST","/users",f).then(function(e){var t={user:e.data,sessionKey:s};if(!r)return t;r(t)})}},{key:"updatePin",value:function(e,t,n,i,r,o){var a={old_pin:e,pin:t};return this.request(n,i,r,"POST","/pin/update",a).then(function(e){if(!o)return e.data;o(e.data)})}},{key:"setupPin",value:function(e,t,n,i){var r=this.encryptPin(e,t.pin_token,t.session_id,n);return this.updatePin("",r,t.user_id,t.session_id,n,i)}},{key:"environment",value:function(){return this.getMixinContext().platform}},{key:"getMixinContext",value:function(){var e={};return window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.MixinContext?(e=JSON.parse(prompt("MixinContext.getContext()"))).platform=e.platform||"iOS":window.MixinContext&&"function"==typeof window.MixinContext.getContext&&((e=JSON.parse(window.MixinContext.getContext())).platform=e.platform||"Android"),e}},{key:"conversationId",value:function(){return this.getMixinContext().conversation_id}},{key:"reloadTheme",value:function(){switch(this.environment()){case"iOS":return void(window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.reloadTheme&&window.webkit.messageHandlers.reloadTheme.postMessage(""));case"Android":case"Desktop":return void(window.MixinContext&&"function"==typeof window.MixinContext.reloadTheme&&window.MixinContext.reloadTheme())}}}])&&r(t.prototype,n),i&&r(t,i),e}()});
