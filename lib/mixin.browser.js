!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("node-forge"),require("int64-buffer"),require("uuid"),require("axios"),require("jssha")):"function"==typeof define&&define.amd?define(["node-forge","int64-buffer","uuid","axios","jssha"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).Mixin=t(e.forge,e.LittleEndian,e.uuid,e.axios,e.jsSHA)}(this,function(e,t,p,n,i){"use strict";function r(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var g=r(e),m=r(t),o=r(n),a=r(i);function y(e){return(y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function f(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}var d=function(){function e(){u(this,e)}return f(e,[{key:"environment",value:function(){return window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.MixinContext?"iOS":window.MixinContext&&window.MixinContext.getContext?"Android":void 0}},{key:"conversationId",value:function(){var e;switch(this.environment()){case"iOS":return e=prompt("MixinContext.getContext()"),JSON.parse(e).conversation_id;case"Android":return e=window.MixinContext.getContext(),JSON.parse(e).conversation_id;default:return e}}},{key:"challenge",value:function(){var e=g.default.random.getBytesSync(32),t=this.base64RawURLEncode(e),n=g.default.md.sha256.create();n.update(e);var i=this.base64RawURLEncode(n.digest().getBytes());return window.localStorage.setItem("verifier",t),i}},{key:"base64RawURLEncode",value:function(e){return e.toString("base64").replace(/\=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}},{key:"hashMembers",value:function(e){var t=e.sort().join(""),n=new a.default("SHA3-256","TEXT",{encoding:"UTF8"});return n.update(t),n.getHash("HEX")}}]),e}(),l=function(){function e(){u(this,e),this.util=new d}return f(e,[{key:"signAuthenticationToken",value:function(e,t,n,i,r,o,a){n=Buffer.from(n,"base64"),i=i.toLocaleUpperCase(),"object"===y(o)?o=JSON.stringify(o):"string"!=typeof o&&(o="");var u=Math.floor(Date.now()/1e3),s=u+3600,f=g.default.md.sha256.create();f.update(i+r+o,"utf8");var d={uid:e,sid:t,iat:u,exp:s,jti:p.v4(),sig:f.digest().toHex(),scp:a||"FULL"},l=[this.util.base64RawURLEncode(Buffer.from(JSON.stringify({alg:"EdDSA",typ:"JWT"}),"utf8")),d=this.util.base64RawURLEncode(Buffer.from(JSON.stringify(d),"utf8"))],c=this.util.base64RawURLEncode(g.default.pki.ed25519.sign({message:l.join("."),encoding:"utf8",privateKey:n}));return l.push(c),l.join(".")}},{key:"request",value:function(e,t,n,i,r,o){var a=this.signAuthenticationToken(e,t,n,i,r,JSON.stringify(o));return requestByToken(i.path,o,a)}},{key:"requestByToken",value:function(e,t,n,i){return o.default({method:e,url:"https://mixin-api.zeromesh.net"+t,data:n,headers:{"Content-Type":"application/json",Authorization:"Bearer "+i}})}}]),e}();return{user:new(function(){function e(){u(this,e),this.client=new l}return f(e,[{key:"generateSessionKeypair",value:function(){var e=g.default.pki.rsa.generateKeyPair({bits:2048,e:65537}),t=g.default.asn1.toDer(g.default.pki.publicKeyToAsn1(e.publicKey)).getBytes();return{public:g.default.util.encode64(t,64),private:g.default.pki.privateKeyToPem(e.privateKey)}}},{key:"encryptPin",value:function(e,t,n,i,r){var o;try{m.default&&(o=m.default.Int64LE),Uint64BE&&(o=Uint64LE)}catch(e){}var a=(i=g.default.pki.privateKeyFromPem(i)).decrypt(g.default.util.decode64(t),"RSA-OAEP",{md:g.default.md.sha256.create(),label:n}),u=new Uint8Array(new o(Math.floor((new Date).getTime()/1e3)).buffer),u=g.default.util.createBuffer(u);r=(r=r||u).getBytes();var s=new Uint8Array(new o(Math.floor((new Date).getTime()/1e3)).buffer);s=(s=g.default.util.createBuffer(s)).getBytes();var f=g.default.util.createBuffer(e,"utf8"),d=g.default.util.createBuffer();d.putBytes(f),d.putBytes(s),d.putBytes(r);for(var l=16-f.length()%16,c=g.default.util.hexToBytes(l.toString(16));0<l;)l--,d.putBytes(c);var p=g.default.random.getBytesSync(16),y=this.hexToBytes(g.default.util.binary.hex.encode(a)),w=g.default.cipher.createCipher("AES-CBC",y);w.start({iv:p}),w.update(d),w.finish(function(){return!0});var h=g.default.util.createBuffer();h.putBytes(p),h.putBytes(w.output.getBytes());var v=h.getBytes();return g.default.util.encode64(v)}},{key:"hexToBytes",value:function(e){for(var t=[],n=0;n<e.length;n+=2)t.push(parseInt(e.substr(n,2),16));return t}},{key:"createUser",value:function(e,t,n,i,r){var o=this.generateSessionKeypair(),a=o.public,u=o.private;-1!==a.indexOf("-----")&&(a.split("-----")[2].replace(/\r?\n|\r/g,""),function(e){throw new TypeError('"'+e+'" is read-only')}("publicKey"));var s=u,f={session_secret:a,full_name:e};return this.client.request(t,n,i,"POST","/users",f).then(function(e){var t={user:e.data,sessionKey:s};if(!r)return t;r(t)})}},{key:"updatePin",value:function(e,t,n,i,r,o){var a={old_pin:e,pin:t};return this.client.request(n,i,r,"POST","/pin/update",a).then(function(e){if(!o)return e.data;o(e.data)})}},{key:"setupPin",value:function(e,t,n,i){var r=this.encryptPin(e,t.pin_token,t.session_id,n);return this.updatePin("",r,t.user_id,t.session_id,n,i)}},{key:"environment",value:function(){return this.getMixinContext().platform}},{key:"getMixinContext",value:function(){var e={};return window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.MixinContext?(e=JSON.parse(prompt("MixinContext.getContext()"))).platform=e.platform||"iOS":window.MixinContext&&"function"==typeof window.MixinContext.getContext&&((e=JSON.parse(window.MixinContext.getContext())).platform=e.platform||"Android"),e}},{key:"conversationId",value:function(){return this.getMixinContext().conversation_id}},{key:"reloadTheme",value:function(){switch(this.environment()){case"iOS":return void(window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.reloadTheme&&window.webkit.messageHandlers.reloadTheme.postMessage(""));case"Android":case"Desktop":return void(window.MixinContext&&"function"==typeof window.MixinContext.reloadTheme&&window.MixinContext.reloadTheme())}}}]),e}()),util:new d,client:new l}});
