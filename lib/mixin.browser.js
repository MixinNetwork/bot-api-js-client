!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("node-forge"),require("moment"),require("int64-buffer"),require("uuid"),require("axios"),require("jssha")):"function"==typeof define&&define.amd?define(["node-forge","moment","int64-buffer","uuid","axios","jssha"],t):(e=e||self).Mixin=t(e.forge,e.moment,e.LittleEndian,e.uuid,e.axios,e.jsSHA)}(this,function(g,m,x,p,o,i){"use strict";function y(e){return(y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function n(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}g=g&&Object.prototype.hasOwnProperty.call(g,"default")?g.default:g,m=m&&Object.prototype.hasOwnProperty.call(m,"default")?m.default:m,x=x&&Object.prototype.hasOwnProperty.call(x,"default")?x.default:x,o=o&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o,i=i&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i;var a=function(){function e(){t(this,e)}return n(e,[{key:"environment",value:function(){return window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.MixinContext?"iOS":window.MixinContext&&window.MixinContext.getContext?"Android":void 0}},{key:"conversationId",value:function(){var e;switch(this.environment()){case"iOS":return e=prompt("MixinContext.getContext()"),JSON.parse(e).conversation_id;case"Android":return e=window.MixinContext.getContext(),JSON.parse(e).conversation_id;default:return e}}},{key:"challenge",value:function(){var e=g.random.getBytesSync(32),t=this.base64RawURLEncode(e),n=g.md.sha256.create();n.update(e);var i=this.base64RawURLEncode(n.digest().getBytes());return window.localStorage.setItem("verifier",t),i}},{key:"base64RawURLEncode",value:function(e){return g.util.encode64(e).replace(/\=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}},{key:"hashMembers",value:function(e){var t=e.sort().join(""),n=new i("SHA3-256","TEXT",{encoding:"UTF8"});return n.update(t),n.getHash("HEX")}}]),e}(),u=function(){function e(){t(this,e),this.util=new a}return n(e,[{key:"signAuthenticationToken",value:function(e,t,n,i,r,o,a){i=i.toLocaleUpperCase(),"object"===y(o)?o=JSON.stringify(o):"string"!=typeof o&&(o="");var u=Math.floor(Date.now()/1e3),s=u+3600,c=g.md.sha256.create();c.update(i+r+o,"utf8");var l={uid:e,sid:t,iat:u,exp:s,jti:p.v4(),sig:c.digest().toHex(),scp:a||"FULL"},f=[Buffer.from(JSON.stringify({alg:"EdDSA",typ:"JWT"}),"utf8").toString("base64"),l],d=this.util.base64rawUrl(g.pki.ed25519.sign({message:f.join("."),encoding:"utf8",privateKey:n}));return f.push(d),f.join(".")}},{key:"request",value:function(e,t,n,i,r,o,a){var u=this.signAuthenticationToken(e,t,n,i,r,JSON.stringify(o));return requestByToken(i.path,o,u,a)}},{key:"requestByToken",value:function(e,t,n,i,r){return o({method:e,url:"https://mixin-api.zeromesh.net"+t,data:n,headers:{"Content-Type":"application/json",Authorization:"Bearer "+i}}).then(function(e){if(!r)return e.data;r(e.data)})}}]),e}();return{user:new(function(){function e(){t(this,e),this.client=new u}return n(e,[{key:"generateSessionKeypair",value:function(){var e=g.pki.rsa.generateKeyPair({bits:2048,e:65537}),t=g.asn1.toDer(g.pki.publicKeyToAsn1(e.publicKey)).getBytes();return{public:g.util.encode64(t,64),private:g.pki.privateKeyToPem(e.privateKey)}}},{key:"encryptPin",value:function(e,t,n,i,r){var o;try{x&&(o=x.Int64LE),Uint64BE&&(o=Uint64LE)}catch(e){}var a=(i=g.pki.privateKeyFromPem(i)).decrypt(g.util.decode64(t),"RSA-OAEP",{md:g.md.sha256.create(),label:n}),u=new Uint8Array(new o(m.utc().unix()).buffer),u=g.util.createBuffer(u);r=(r=r||u).getBytes();var s=new Uint8Array(new o(m.utc().unix()).buffer);s=(s=g.util.createBuffer(s)).getBytes();var c=g.util.createBuffer(e,"utf8"),l=g.util.createBuffer();l.putBytes(c),l.putBytes(s),l.putBytes(r);for(var f=16-c.length()%16,d=g.util.hexToBytes(f.toString(16));0<f;)f--,l.putBytes(d);var p=g.random.getBytesSync(16),y=this.hexToBytes(g.util.binary.hex.encode(a)),w=g.cipher.createCipher("AES-CBC",y);w.start({iv:p}),w.update(l),w.finish(function(){return!0});var h=g.util.createBuffer();h.putBytes(p),h.putBytes(w.output.getBytes());var v=h.getBytes();return g.util.encode64(v)}},{key:"hexToBytes",value:function(e){for(var t=[],n=0;n<e.length;n+=2)t.push(parseInt(e.substr(n,2),16));return t}},{key:"createUser",value:function(e,t,n,i,r){var o=this.generateSessionKeypair(),a=o.public,u=o.private;-1!==a.indexOf("-----")&&(function(e){throw new Error('"'+e+'" is read-only')}("publicKey"),a=a.split("-----")[2].replace(/\r?\n|\r/g,""));var s=u,c={session_secret:a,full_name:e};return this.client.request(t,n,i,"POST","/users",c).then(function(e){var t={user:e.data,sessionKey:s};if(!r)return t;r(t)})}},{key:"updatePin",value:function(e,t,n,i,r,o){var a={old_pin:e,pin:t};return this.client.request(n,i,r,"POST","/pin/update",a).then(function(e){if(!o)return e.data;o(e.data)})}},{key:"setupPin",value:function(e,t,n,i){var r=this.encryptPin(e,t.pin_token,t.session_id,n);return this.updatePin("",r,t.user_id,t.session_id,n,i)}},{key:"environment",value:function(){return this.getMixinContext().platform}},{key:"getMixinContext",value:function(){var e={};return window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.MixinContext?(e=JSON.parse(prompt("MixinContext.getContext()"))).platform=e.platform||"iOS":window.MixinContext&&"function"==typeof window.MixinContext.getContext&&((e=JSON.parse(window.MixinContext.getContext())).platform=e.platform||"Android"),e}},{key:"conversationId",value:function(){return this.getMixinContext().conversation_id}},{key:"reloadTheme",value:function(){switch(this.environment()){case"iOS":return void(window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.reloadTheme&&window.webkit.messageHandlers.reloadTheme.postMessage(""));case"Android":case"Desktop":return void(window.MixinContext&&"function"==typeof window.MixinContext.reloadTheme&&window.MixinContext.reloadTheme())}}}]),e}()),util:new a,client:new u}});
